define
a#1,SET:b
----

iter
first
next
----
a#1,SET:b
.

define
a#2,SET:c
a#1,SET:b
----

iter
first
next
----
a#2,SET:c
.

iter snapshots=0
first
next
----
a#2,SET:c
.

iter snapshots=1
first
next
----
a#2,SET:c
.

iter snapshots=2
first
next
next
----
a#2,SET:c
a#1,SET:b
.

define
a#2,DEL:
a#1,SET:b
----

iter
first
next
----
a#2,DEL:
.

iter elide-tombstones=true
first
----
.

iter elide-tombstones=true snapshots=2
first
next
next
----
a#2,DEL:
a#1,SET:b
.

iter elide-tombstones=true snapshots=1
first
next
----
a#2,DEL:
.

define
a#2,DEL:
a#1,SET:b
b#3,SET:c
----

iter
first
next
next
----
a#2,DEL:
b#3,SET:c
.

iter snapshots=1
first
next
next
----
a#2,DEL:
b#3,SET:c
.

iter snapshots=2
first
next
next
next
----
a#2,DEL:
a#1,SET:b
b#3,SET:c
.

define
a#1,SET:a
b#2,SET:b
c#3,SET:c
----

iter
first
next
next
next
----
a#1,SET:a
b#2,SET:b
c#3,SET:c
.

define
a#3,MERGE:d
a#2,MERGE:c
a#1,SET:b
b#2,MERGE:b
b#1,MERGE:a
----

iter
first
next
next
----
a#3,SET:bcd[base]
b#2,MERGE:ab
.

iter snapshots=3
first
next
next
next
----
a#3,MERGE:d
a#2,SET:bc[base]
b#2,MERGE:ab
.

define
a#9,SET:b
a#8,DEL:
a#7,SET:d
a#6,DEL:
a#5,SET:f
----

iter
first
next
----
a#9,SETWITHDEL:b
.

iter snapshots=6
first
next
next
----
a#9,SETWITHDEL:b
a#5,SET:f
.

iter snapshots=7
first
next
next
----
a#9,SETWITHDEL:b
a#6,DEL:
.

iter snapshots=8
first
next
next
----
a#9,SETWITHDEL:b
a#7,SETWITHDEL:d
.

iter snapshots=9
first
next
next
----
a#9,SET:b
a#8,DEL:
.

iter snapshots=10
first
next
----
a#9,SETWITHDEL:b
.

iter snapshots=(5,6,7,8,9)
first
next
next
next
next
next
----
a#9,SET:b
a#8,DEL:
a#7,SET:d
a#6,DEL:
a#5,SET:f
.

define
a#2,INVALID:b
a#1,SET:c
----

iter
first
----
err=invalid internal key kind: INVALID

define
a#2,SET:b
a#1,INVALID:c
----

iter
first
----
err=invalid internal key kind: INVALID

define
a#2,MERGE:b
a#1,INVALID:c
----

iter
first
----
err=invalid internal key kind: INVALID

define
a#2,INVALID:c
a#1,RANGEDEL:d
----

iter
first
next
----
a#inf,RANGEDEL:; Span() = a-d:{(#1,RANGEDEL)}
err=invalid internal key kind: INVALID

define
a#2,MERGE:b
a#1,MERGE:c
a#0,MERGE:d
----

iter snapshots=(1,2)
first
next
next
next
----
a#2,MERGE:b
a#1,MERGE:c
a#0,MERGE:d
.

define
a#2,SET:b
a#1,RANGEDEL:c
b#4,RANGEDEL:d
b#2,SET:e
c#3,SET:f
----

iter
first
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#1,RANGEDEL)}
a#2,SET:b
b#inf,RANGEDEL:; Span() = b-c:{(#4,RANGEDEL)}
c#inf,RANGEDEL:; Span() = c-d:{(#4,RANGEDEL)}
.

iter snapshots=2
first
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#1,RANGEDEL)}
a#2,SET:b
b#inf,RANGEDEL:; Span() = b-c:{(#4,RANGEDEL) (#1,RANGEDEL)}
c#inf,RANGEDEL:; Span() = c-d:{(#4,RANGEDEL)}
.

iter snapshots=3
first
next
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#1,RANGEDEL)}
a#2,SET:b
b#inf,RANGEDEL:; Span() = b-c:{(#4,RANGEDEL) (#1,RANGEDEL)}
b#2,SET:e
c#inf,RANGEDEL:; Span() = c-d:{(#4,RANGEDEL)}
.

iter snapshots=4
first
next
next
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#1,RANGEDEL)}
a#2,SET:b
b#inf,RANGEDEL:; Span() = b-c:{(#4,RANGEDEL) (#1,RANGEDEL)}
b#2,SET:e
c#inf,RANGEDEL:; Span() = c-d:{(#4,RANGEDEL)}
c#3,SET:f
.

define
a#3,RANGEDEL:e
b#4,SET:b
c#3,SET:c
d#2,SET:d
e#1,SET:e
----

iter
first
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-e:{(#3,RANGEDEL)}
b#4,SET:b
c#3,SET:c
e#1,SET:e
.

define
a#3,RANGEDEL:e
b#4,MERGE:b
c#3,MERGE:c
d#2,MERGE:d
e#1,MERGE:e
----

iter
first
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-e:{(#3,RANGEDEL)}
b#4,MERGE:b
c#3,MERGE:c
e#1,MERGE:e
.

define
a#3,RANGEDEL:c
b#5,MERGE:e
b#4,MERGE:d
b#2,MERGE:c
b#1,MERGE:b
d#5,MERGE:c
d#4,MERGE:b
d#3,RANGEDEL:f
d#2,MERGE:e
d#1,MERGE:d
----

iter
first
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-c:{(#3,RANGEDEL)}
b#5,MERGE:de
d#inf,RANGEDEL:; Span() = d-f:{(#3,RANGEDEL)}
d#5,MERGE:bc
.

define
a#3,RANGEDEL:d
b#2,RANGEDEL:e
c#1,RANGEDEL:f
----

iter
first
next
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#3,RANGEDEL)}
b#inf,RANGEDEL:; Span() = b-c:{(#3,RANGEDEL)}
c#inf,RANGEDEL:; Span() = c-d:{(#3,RANGEDEL)}
d#inf,RANGEDEL:; Span() = d-e:{(#2,RANGEDEL)}
e#inf,RANGEDEL:; Span() = e-f:{(#1,RANGEDEL)}
.

iter snapshots=2
first
next
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#3,RANGEDEL)}
b#inf,RANGEDEL:; Span() = b-c:{(#3,RANGEDEL)}
c#inf,RANGEDEL:; Span() = c-d:{(#3,RANGEDEL) (#1,RANGEDEL)}
d#inf,RANGEDEL:; Span() = d-e:{(#2,RANGEDEL) (#1,RANGEDEL)}
e#inf,RANGEDEL:; Span() = e-f:{(#1,RANGEDEL)}
.

iter snapshots=3
first
next
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#3,RANGEDEL)}
b#inf,RANGEDEL:; Span() = b-c:{(#3,RANGEDEL) (#2,RANGEDEL)}
c#inf,RANGEDEL:; Span() = c-d:{(#3,RANGEDEL) (#2,RANGEDEL)}
d#inf,RANGEDEL:; Span() = d-e:{(#2,RANGEDEL)}
e#inf,RANGEDEL:; Span() = e-f:{(#1,RANGEDEL)}
.

iter snapshots=(2,3)
first
next
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#3,RANGEDEL)}
b#inf,RANGEDEL:; Span() = b-c:{(#3,RANGEDEL) (#2,RANGEDEL)}
c#inf,RANGEDEL:; Span() = c-d:{(#3,RANGEDEL) (#2,RANGEDEL) (#1,RANGEDEL)}
d#inf,RANGEDEL:; Span() = d-e:{(#2,RANGEDEL) (#1,RANGEDEL)}
e#inf,RANGEDEL:; Span() = e-f:{(#1,RANGEDEL)}
.

define
a#10,RANGEDEL:k
f#9,SET:f
f#8,SET:f
----

iter snapshots=(9,10)
first
next
next
----
a#inf,RANGEDEL:; Span() = a-k:{(#10,RANGEDEL)}
f#9,SET:f
f#8,SET:f

define
f#10,RANGEDEL:k
f#9,SET:f
f#8,SET:f
----

iter snapshots=(9,10)
first
next
next
----
f#inf,RANGEDEL:; Span() = f-k:{(#10,RANGEDEL)}
f#9,SET:f
f#8,SET:f

define
a#1,SET:a
b#2,RANGEDEL:d
c#3,RANGEDEL:e
d#4,SET:d
----

iter
first
next
next
next
next
next
----
a#1,SET:a
b#inf,RANGEDEL:; Span() = b-c:{(#2,RANGEDEL)}
c#inf,RANGEDEL:; Span() = c-d:{(#3,RANGEDEL)}
d#inf,RANGEDEL:; Span() = d-e:{(#3,RANGEDEL)}
d#4,SET:d
.

iter snapshots=3
first
next
next
next
next
next
----
a#1,SET:a
b#inf,RANGEDEL:; Span() = b-c:{(#2,RANGEDEL)}
c#inf,RANGEDEL:; Span() = c-d:{(#3,RANGEDEL) (#2,RANGEDEL)}
d#inf,RANGEDEL:; Span() = d-e:{(#3,RANGEDEL)}
d#4,SET:d
.

define
a#1,SET:a
b#2,RANGEDEL:d
c#4,SET:d
----

iter
first
next
next
----
a#1,SET:a
b#inf,RANGEDEL:; Span() = b-d:{(#2,RANGEDEL)}
c#4,SET:d

define
a#2,RANGEDEL:d
a#2,SET:a
b#2,SET:b
c#2,SET:c
----

iter
first
next
next
next
next
----
a#inf,RANGEDEL:; Span() = a-d:{(#2,RANGEDEL)}
a#2,SET:a
b#2,SET:b
c#2,SET:c
.

define
a#1,SINGLEDEL:
----

iter
first
next
----
a#1,SINGLEDEL:
.

iter elide-tombstones=true
first
----
.
ineffectual-single-deletes: a

define
a#2,SINGLEDEL:
a#1,SINGLEDEL:
----

iter
first
next
----
a#2,SINGLEDEL:
.
ineffectual-single-deletes: a

define
a#3,SINGLEDEL:
a#2,SINGLEDEL:
a#1,SET:a
----

iter
first
----
.
ineffectual-single-deletes: a

define
a#3,SET:a
b#2,SINGLEDEL:
b#1,DEL:
----

iter
first
next
next
----
a#3,SET:a
b#2,DEL:
.
ineffectual-single-deletes: b

define
a#2,SINGLEDEL:
a#1,DEL:
----

iter
first
next
----
a#2,DEL:
.
ineffectual-single-deletes: a

iter elide-tombstones=true
first
----
.
ineffectual-single-deletes: a

define
a#2,SINGLEDEL:
a#1,MERGE:a
----

iter
first
----
.

iter elide-tombstones=true
first
----
.

define
a#2,SINGLEDEL:
a#1,SET:b
----

iter
first
----
.

# SET that meets a SINGLEDEL is transformed into a SETWITHDEL.

define
a#2,SET:b
a#1,SINGLEDEL:
----

iter
first
next
----
a#2,SETWITHDEL:b
.

# We don't notice the ineffectual single delete since the SET causes all
# SingleDelete error checking to be skipped.
iter elide-tombstones=true
first
next
----
a#2,SETWITHDEL:b
.

define
a#6,MERGE:b
a#5,SINGLEDEL:
a#4,SET:a
----

iter
first
next
----
a#6,SETWITHDEL:b[base]
.

# Non-deterministic use of SINGLEDEL where there are two older SETs that have
# not been deleted or single deleted. It is permitted to shadow both, since
# MERGE turns into a SETWITHDELETE when it meets the SINGLEDEL.
define
a#6,MERGE:b
a#5,SINGLEDEL:
a#4,SET:a
a#3,SET:a
----

iter
first
next
----
a#6,SETWITHDEL:b[base]
.

define
a#2,SINGLEDEL:
a#1,SET:b
b#3,SET:c
----

iter
first
next
----
b#3,SET:c
.

define
a#3,SINGLEDEL:
a#2,SET:b
a#1,SET:a
----

iter
first
next
----
a#1,SET:a
.
invariant-violation-single-deletes: a

define
a#3,SINGLEDEL:
a#2,MERGE:b
a#1,MERGE:a
----

# SINGLEDEL consumes the first MERGE.
iter
first
next
----
a#1,MERGE:a
.
invariant-violation-single-deletes: a

define
a#4,SINGLEDEL:
a#3,SET:val
a#2,SINGLEDEL:
a#1,SET:val
----

iter
first
----
.

iter snapshots=2
first
next
next
----
a#2,SINGLEDEL:
a#1,SET:val
.

define
a#4,SINGLEDEL:
a#3,SET:val
a#2,DEL:
a#1,SET:val
----

iter
first
next
----
a#2,DEL:
.

iter snapshots=2
first
next
next
----
a#2,DEL:
a#1,SET:val
.

iter snapshots=3
first
next
----
a#2,DEL:
.

iter snapshots=(2,3)
first
next
next
----
a#2,DEL:
a#1,SET:val
.

define
a#4,SINGLEDEL:
a#3,SET:c
a#2,MERGE:b
a#1,SET:a
----

iter
first
next
----
a#2,SET:ab[base]
.
invariant-violation-single-deletes: a

iter snapshots=2
first
next
next
----
a#2,MERGE:b
a#1,SET:a
.
invariant-violation-single-deletes: a

iter snapshots=3
first
next
----
a#2,SET:ab[base]
.
invariant-violation-single-deletes: a

iter snapshots=(2,3,4)
first
next
next
next
next
----
a#4,SINGLEDEL:
a#3,SET:c
a#2,MERGE:b
a#1,SET:a
.

define
a#3,SINGLEDEL:
a#2,RANGEDEL:c
a#1,SET:val
----

iter
first
next
next
----
a#inf,RANGEDEL:; Span() = a-c:{(#2,RANGEDEL)}
a#3,SINGLEDEL:
.

define
a#3,RANGEDEL:d
a#2,DEL:
a#1,SET:a
d#2,DEL:
----

iter
first
next
next
----
a#inf,RANGEDEL:; Span() = a-d:{(#3,RANGEDEL)}
d#2,DEL:
.

iter snapshots=3
first
next
----
a#inf,RANGEDEL:; Span() = a-d:{(#3,RANGEDEL)}
a#2,DEL:

define
a#2,MERGE:v2
a#1,RANGEDEL:b
a#1,MERGE:v1
----

iter is-bottommost-layer=true
first
next
next
----
a#inf,RANGEDEL:; Span() = a-b:{(#1,RANGEDEL)}
a#0,SET:v1v2[base]
.

# Verify that we transform merge+del -> set.

define
a#5,MERGE:5
a#3,DEL:
a#1,MERGE:1
----

iter
first
next
----
a#5,SETWITHDEL:5[base]
.

iter is-bottommost-layer=true
first
next
----
a#0,SETWITHDEL:5[base]
.

iter elide-tombstones=true
first
next
----
a#5,SETWITHDEL:5[base]
.

iter snapshots=2
first
next
next
----
a#5,SETWITHDEL:5[base]
a#1,MERGE:1
.

iter snapshots=2 elide-tombstones=true
first
next
next
----
a#5,SETWITHDEL:5[base]
a#1,MERGE:1
.

# Verify that merge+rangedel -> merge.

define
a#3,RANGEDEL:c
b#5,MERGE:5
b#2,SET:2
b#1,MERGE:1
----

iter
first
next
next
----
a#inf,RANGEDEL:; Span() = a-c:{(#3,RANGEDEL)}
b#5,MERGE:5
.

iter is-bottommost-layer=true
first
next
next
----
a#inf,RANGEDEL:; Span() = a-c:{(#3,RANGEDEL)}
b#0,SET:5[base]
.

iter snapshots=2
first
next
next
----
a#inf,RANGEDEL:; Span() = a-c:{(#3,RANGEDEL)}
b#5,MERGE:5
b#1,MERGE:1

define
a#3,RANGEDEL:c
b#5,MERGE:5
b#2,MERGE:2
b#1,MERGE:1
----

iter
first
next
next
----
a#inf,RANGEDEL:; Span() = a-c:{(#3,RANGEDEL)}
b#5,MERGE:5
.

iter snapshots=2
first
next
next
----
a#inf,RANGEDEL:; Span() = a-c:{(#3,RANGEDEL)}
b#5,MERGE:5
b#1,MERGE:1

# SET that meets a DEL is transformed into a SETWITHDEL.

define
a#2,SET:b
a#1,DEL:
----

iter
first
next
----
a#2,SETWITHDEL:b
.

iter snapshots=2
first
next
next
----
a#2,SET:b
a#1,DEL:
.

define
a#3,SET:c
a#2,DEL:
a#1,SET:b
----

iter
first
next
----
a#3,SETWITHDEL:c
.

iter snapshots=2
first
next
next
----
a#3,SETWITHDEL:c
a#1,SET:b
.

define
a#3,SET:c
a#2,SET:b
a#1,DEL:
----

iter
first
next
----
a#3,SETWITHDEL:c
.

iter snapshots=3
first
next
next
----
a#3,SET:c
a#2,SETWITHDEL:b
.

iter snapshots=2
first
next
next
----
a#3,SET:c
a#1,DEL:
.

define
a#3,DEL:
a#2,SET:b
a#1,DEL:
----

iter
first
next
----
a#3,DEL:
.

iter snapshots=3
first
next
next
----
a#3,DEL:
a#2,SETWITHDEL:b
.

iter snapshots=2
first
next
next
----
a#3,DEL:
a#1,DEL:
.

# SETWITHDEL-eligible entries at or under a RANGEDEL at the same user key should
# be skipped.

define
a#3,SET:c
a#2,RANGEDEL:z
a#2,SET:b
a#1,DEL:
----

iter is-bottommost-layer=true
first
next
next
----
a#inf,RANGEDEL:; Span() = a-z:{(#2,RANGEDEL)}
a#0,SET:c
.

iter is-bottommost-layer=true snapshots=3
first
next
next
next
----
a#inf,RANGEDEL:; Span() = a-z:{(#2,RANGEDEL)}
a#3,SET:c
a#0,SET:b
.

iter is-bottommost-layer=true snapshots=2
first
next
next
next
----
a#inf,RANGEDEL:; Span() = a-z:{(#2,RANGEDEL)}
a#3,SET:c
a#1,DEL:
.

define
a#4,SET:c
a#3,RANGEDEL:z
a#2,SET:b
a#1,DEL:
----

iter
first
next
next
----
a#inf,RANGEDEL:; Span() = a-z:{(#3,RANGEDEL)}
a#4,SET:c
.

# Invalid keys are emitted under SETWITHDEL.

define
a#2,SET:b
a#1,INVALID:c
----

iter
first
----
err=invalid internal key kind: INVALID

define
a#3,SET:c
a#2,INVALID:c
a#1,SET:b
----

iter
first
----
err=invalid internal key kind: INVALID

# SINGLEDEL that meets a SETWITHDEL is transformed into a DEL.

define
a#3,SINGLEDEL:
a#2,SETWITHDEL:d
b#1,SET:c
----

iter
first
next
next
----
a#3,DEL:
b#1,SET:c
.

iter snapshots=2
first
next
next
----
a#3,DEL:
b#1,SET:c
.

iter snapshots=3
first
next
next
next
----
a#3,SINGLEDEL:
a#2,SETWITHDEL:d
b#1,SET:c
.

define
a#3,SETWITHDEL:3
a#2,SET:d
b#1,SET:c
----

iter
first
next
next
----
a#3,SETWITHDEL:3
b#1,SET:c
.

iter snapshots=3
first
next
next
next
----
a#3,SETWITHDEL:3
a#2,SET:d
b#1,SET:c
.
