# Open a database without WAL failover configured.

open path=(a,data)
----
ok

list path=(a,data)
----
  000003.log
  LOCK
  MANIFEST-000001
  OPTIONS-000002
  marker.format-version.000001.013
  marker.manifest.000001.MANIFEST-000001

# The OPTIONS file should not include a [WAL Failover] stanza.

grep-between path=(a,data/OPTIONS-000002) start=(\[WAL Failover\]) end=^$
----

# Open the same database with WAL failover configured, but pointing to a
# different FS.

open path=(a,data) secondary=(b,secondary-wals)
----
ok

# Open should have created the 'secondary-wals' directory on the 'b' FS.

list path=(b,)
----
  secondary-wals

list path=(a,data)
----
  000007.log
  LOCK
  MANIFEST-000001
  MANIFEST-000006
  OPTIONS-000005
  marker.format-version.000001.013
  marker.manifest.000002.MANIFEST-000006

# The new OPTIONS file should declare the secondary WAL path.

grep-between path=(a,data/OPTIONS-000005) start=(\[WAL Failover\]) end=^$
----
  secondary_dir=secondary-wals
  primary_dir_probe_interval=1s
  healthy_probe_latency_threshold=25ms
  healthy_interval=15s
  unhealthy_sampling_interval=100ms
  unhealthy_operation_latency_threshold=100ms
  elevated_write_stall_threshold_lag=1m0s

# Opening the same directory without providing the secondary path in either the
# WAL failover configuration or as a WALRecoveryDir should error.

open path=(a,data)
----
directory "secondary-wals" may contain relevant WALs but is not in WALRecoveryDirs
  WALFailover.Secondary changed from previous options
  o.WALDir: ""
  o.WALRecoveryDirs: 0

# But opening the same directory while providing the secondary path as a WAL
# recovery dir should succeed.

open path=(a,data) wal-recovery-dir=(b,secondary-wals)
----
ok

open path=(c,data) wal-dir=(c,wal1)
----
ok

# We cannot change the WAL directory without providing the previous one as a recovery dir.
open path=(c,data) wal-dir=(c,wal2)
----
directory "wal1" may contain relevant WALs but is not in WALRecoveryDirs
  WALDir changed from previous options
  o.WALDir: "wal2"
  o.WALRecoveryDirs: 0

open path=(c,data) wal-dir=(c,wal2) wal-recovery-dir=(c,wal1)
----
ok

# Once we opened the database once (and thus replayed any WALs in the previous
# WAL dir), we can open without a recovery dir.
open path=(c,data) wal-dir=(c,wal2)
----
ok

open path=(c,data) wal-dir=(c,wal3)
----
directory "wal2" may contain relevant WALs but is not in WALRecoveryDirs
  WALDir changed from previous options
  o.WALDir: "wal3"
  o.WALRecoveryDirs: 0

# Test the Unsafe.AllowMissingWALDirs option.
open path=(c,data) wal-dir=(c,wal3) allow-missing-wal-dirs
----
ok

open path=(c,data) wal-dir=(c,wal3) secondary=(d,secondary)
----
ok

open path=(c,data) wal-dir=(c,wal3)
----
directory "secondary" may contain relevant WALs but is not in WALRecoveryDirs
  WALFailover.Secondary changed from previous options
  o.WALDir: "wal3"
  o.WALRecoveryDirs: 0

open path=(c,data) wal-dir=(c,wal3) allow-missing-wal-dirs
----
ok
