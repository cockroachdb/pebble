reset
----

batch commit
set a a
set b b
set c c
set d d
----
committed 4 keys

# Scan forward

combined-iter
seek-ge a
next
next
next
next
----
a: (a, .)
b: (b, .)
c: (c, .)
d: (d, .)
.

reopen
----

combined-iter
first
next
next
next
next
----
a: (a, .)
b: (b, .)
c: (c, .)
d: (d, .)
.

reopen enable-table-stats=false inject-errors=((ErrInjected (And Reads (PathMatch "*.sst") (OnIndex 4))))
----

combined-iter
first
first
next
next
next
next
----
err=pebble: backing file 000004 error: injected error
a: (a, .)
b: (b, .)
c: (c, .)
d: (d, .)
.

# Regression test for #2994.
#
# Previously, an error while loading an L0 sstable's range key block could
# result in an iterator that would always return the same error. Now, the IO is
# deferred to the first seek. If a seek encounters an IO error, re-seeking the
# iterator should re-attempt the failed IO operation, potentially succeeding if
# the IO error was transient.

define auto-compactions=off
L0
  a.SET.9:a
  rangekey:c-d:{(#0,RANGEKEYSET,@1,foo)}
  e@2.SET.2:e@2
----
0.0:
  000004:[a#9,SET-e@2#2,SET]

layout filename=000004.sst
----
         0  data (38)
        43  index (35)
        83  range-key (29)
       117  properties (645)
       767  meta-index (57)
       829  footer (53)
       882  EOF

# Inject an error on the first `ReadAt` call on 000004.sst's range key block
# (which is at offset 83).

reopen auto-compactions=off enable-table-stats=false inject-errors=((ErrInjected (And (PathMatch "000004.sst") (OpFileReadAt 83) (OnIndex 0))))
----

combined-iter
first
first
----
err=injected error
a: (a, .)

# Test a scenario where an error occurs while the top-level Iterator is
# Prev()-ing backwards through many versions of the same user key. In the below
# test, reading the first block of the sstable (containing c.SET.13) fails. The
# iterator must surface the error. Previously a bug existed that would allow the
# iterator to mistakenly surface c.SET.12.

define auto-compactions=off block-size=1 snapshots=(10,11,12,13)
L1
  c.SET.13:c13
  c.SET.12:c12
  c.SET.11:c11
  c.SET.10:c10
  c.SET.9:c9
  c.SET.8:c8
  d.SET.9:d9
  e.SET.9:e9
----
1:
  000004:[c#13,SET-e#9,SET]

layout filename=000004.sst
----
         0  data (23)
        28  data (23)
        56  data (23)
        84  data (23)
       112  data (22)
       139  data (22)
       166  data (22)
       193  index (113)
       311  properties (643)
       959  meta-index (33)
       997  footer (53)
      1050  EOF

reopen auto-compactions=off enable-table-stats=false inject-errors=((ErrInjected (And (PathMatch "000004.sst") (OpFileReadAt 0))))
----

combined-iter
last
prev
prev
----
e: (e9, .)
d: (d9, .)
err=injected error
