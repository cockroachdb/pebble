name: PR tests

on:
  push:
    branches:
      - master
      - crl-release-*
      - pebble-release-*

  pull_request:
    branches:
      - master
      - crl-release-*
      - pebble-release-*

jobs:

  # This check is required to merge PRs.
  go-linux:
    name: go-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - run: GOTRACEBACK=all make test testobjiotracing generate

      - name: Assert workspace clean
        run: scripts/check-workspace-clean.sh

  # This check is required to merge PRs.
  go-lint-checks:
    name: go-lint-checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: mod-tidy-check
        run: make mod-tidy-check

      - name: format-check
        run: make format-check

  linux-no-invariants:
    name: go-linux-no-invariants
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - run: GOTRACEBACK=all make test TAGS=

  linux-no-cgo:
    name: go-linux-no-cgo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - run: GOTRACEBACK=all make testnocgo

  linux-race:
    name: linux-race
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      - run: GOTRACEBACK=all make testrace TAGS=

  darwin:
    name: go-macos
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - run: GOTRACEBACK=all make test

  stress-new-tests:
    if: github.event_name == 'pull_request'  # Skip job unless it's a PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Stress new tests
        env:
          BASE_BRANCH: origin/${{ github.base_ref }}
        run: |
          go install github.com/cockroachdb/stress@latest
          bash scripts/stress-new-tests.sh
