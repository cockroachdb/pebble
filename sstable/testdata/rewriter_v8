build block-size=1 index-block-size=1 filter
a@xyz#1,SET:a
b@xyz#1,SET:b
c@xyz#1,SET:c
----
point:    [a@xyz#1,SET-c@xyz#1,SET]
seqnums:  [#1-#1]

rewrite from=@xyz to=@123 block-size=1 index-block-size=1 filter comparer=split-4b-suffix
----
rewrite failed: mismatched Comparer pebble.internal.testkeys vs comparer-split-4b-suffix, replacement requires same splitter to copy filters

build block-size=1 index-block-size=1 filter
aa@xyz#1,SET:a
ba@xyz#1,SET:b
ca@xyz#1,SET:c
----
point:    [aa@xyz#1,SET-ca@xyz#1,SET]
seqnums:  [#1-#1]

rewrite from=yz to=23 block-size=1 index-block-size=1
----
rewrite failed: rewriting data blocks: key aa@xyz#1,SET has suffix 0x4078797a; require 0x797a

rewrite from=a@xyz to=a@123 block-size=1 index-block-size=1 filter
----
rewrite failed: rewriting data blocks: key aa@xyz#1,SET has suffix 0x4078797a; require 0x614078797a

build block-size=1 index-block-size=1 filter
a@0#1,SET:a
b@0#1,SET:b
c@0#1,SET:c
----
point:    [a@0#1,SET-c@0#1,SET]
seqnums:  [#1-#1]

layout
----
sstable
 ├── data  offset: 0  length: 91
 ├── data  offset: 96  length: 91
 ├── data  offset: 192  length: 91
 ├── index  offset: 288  length: 38
 ├── index  offset: 331  length: 39
 ├── index  offset: 375  length: 37
 ├── top-index  offset: 417  length: 52
 ├── fullfilter.rocksdb.BuiltinBloomFilter  offset: 474  length: 69
 ├── properties  offset: 548  length: 494
 ├── meta-index  offset: 1047  length: 88
 └── footer  offset: 1140  length: 61

scan
----
a@0#1,SET:a
b@0#1,SET:b
c@0#1,SET:c

get
b@0
f@0
c@0
----
b
get f@0: pebble: not found
c

rewrite from=@0 to=@123 block-size=1 index-block-size=1 filter
----
point:    [a@123#1,SET-c@123#1,SET]
seqnums:  [#1-#1]

layout
----
sstable
 ├── data  offset: 0  length: 106
 ├── data  offset: 111  length: 106
 ├── data  offset: 222  length: 106
 ├── index  offset: 333  length: 40
 ├── index  offset: 378  length: 41
 ├── index  offset: 424  length: 37
 ├── top-index  offset: 466  length: 56
 ├── fullfilter.rocksdb.BuiltinBloomFilter  offset: 527  length: 69
 ├── properties  offset: 601  length: 483
 ├── meta-index  offset: 1089  length: 88
 └── footer  offset: 1182  length: 61

scan
----
a@123#1,SET:a
b@123#1,SET:b
c@123#1,SET:c

get
b@123
f@123
c@123
----
b
get f@123: pebble: not found
c

rewrite from=@123 to=@456 block-size=1 index-block-size=1 concurrency=2
----
point:    [a@456#1,SET-c@456#1,SET]
seqnums:  [#1-#1]

layout
----
sstable
 ├── data  offset: 0  length: 106
 ├── data  offset: 111  length: 106
 ├── data  offset: 222  length: 106
 ├── index  offset: 333  length: 40
 ├── index  offset: 378  length: 41
 ├── index  offset: 424  length: 37
 ├── top-index  offset: 466  length: 56
 ├── fullfilter.rocksdb.BuiltinBloomFilter  offset: 527  length: 69
 ├── properties  offset: 601  length: 483
 ├── meta-index  offset: 1089  length: 88
 └── footer  offset: 1182  length: 61

scan
----
a@456#1,SET:a
b@456#1,SET:b
c@456#1,SET:c

get
b@456
f@456
c@456
----
b
get f@456: pebble: not found
c

rewrite from=@456 to=@123 block-size=1 index-block-size=1 filter concurrency=3
----
point:    [a@123#1,SET-c@123#1,SET]
seqnums:  [#1-#1]

layout
----
sstable
 ├── data  offset: 0  length: 106
 ├── data  offset: 111  length: 106
 ├── data  offset: 222  length: 106
 ├── index  offset: 333  length: 40
 ├── index  offset: 378  length: 41
 ├── index  offset: 424  length: 37
 ├── top-index  offset: 466  length: 56
 ├── fullfilter.rocksdb.BuiltinBloomFilter  offset: 527  length: 69
 ├── properties  offset: 601  length: 483
 ├── meta-index  offset: 1089  length: 88
 └── footer  offset: 1182  length: 61

scan
----
a@123#1,SET:a
b@123#1,SET:b
c@123#1,SET:c

get
b@123
f@123
c@123
----
b
get f@123: pebble: not found
c


rewrite from=@123 to=@0 block-size=1 index-block-size=1 concurrency=4
----
point:    [a@0#1,SET-c@0#1,SET]
seqnums:  [#1-#1]

layout
----
sstable
 ├── data  offset: 0  length: 91
 ├── data  offset: 96  length: 91
 ├── data  offset: 192  length: 91
 ├── index  offset: 288  length: 38
 ├── index  offset: 331  length: 39
 ├── index  offset: 375  length: 37
 ├── top-index  offset: 417  length: 52
 ├── fullfilter.rocksdb.BuiltinBloomFilter  offset: 474  length: 69
 ├── properties  offset: 548  length: 494
 ├── meta-index  offset: 1047  length: 88
 └── footer  offset: 1140  length: 61

scan
----
a@0#1,SET:a
b@0#1,SET:b
c@0#1,SET:c

get
b@0
f@0
c@0
----
b
get f@0: pebble: not found
c

# Rewrite a table that contain only range keys.

build block-size=1 index-block-size=1 filter
Span: a-b:{(#1,RANGEKEYSET,@0)}
Span: b-c:{(#1,RANGEKEYSET,@0)}
Span: c-d:{(#1,RANGEKEYSET,@0)}
----
rangekey: [a#1,RANGEKEYSET-d#inf,RANGEKEYSET]
seqnums:  [#1-#1]

scan-range-key
----
a-b:{(#1,RANGEKEYSET,@0)}
b-c:{(#1,RANGEKEYSET,@0)}
c-d:{(#1,RANGEKEYSET,@0)}

rewrite from=@0 to=@123 block-size=1 index-block-size=1 filter
----
rangekey: [a#1,RANGEKEYSET-d#inf,RANGEKEYSET]
seqnums:  [#1-#1]

scan-range-key
----
a-b:{(#1,RANGEKEYSET,@123)}
b-c:{(#1,RANGEKEYSET,@123)}
c-d:{(#1,RANGEKEYSET,@123)}

build block-size=1 index-block-size=1 filter
a#1,SET:a
b#1,SET:b
c#1,SET:c
----
point:    [a#1,SET-c#1,SET]
seqnums:  [#1-#1]

rewrite from= to=@123 block-size=1 index-block-size=1 filter
----
point:    [a@123#1,SET-c@123#1,SET]
seqnums:  [#1-#1]
